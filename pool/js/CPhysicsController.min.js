function CPhysicsController(e){var t,r,o,s,a,l,n,i,u,c,h,_,L,g,N,A,p,E,B,P,I,O,d,C,T,f,F=this;this._init=function(e){t=!0,l=0,r=new Array,o=new Array,f=e,this._initCollisions()},this._initCollisions=function(){a=new Array,T=new createjs.Rectangle(0,0,POOL_HOLE_RADIUS,POOL_HOLE_RADIUS),n=new Array,i=new Array,u=new Array,c=new Array,L=new Array,h=new Array;for(var e=0;e<FIELD_POINTS.length-1;e++){t=new CEdge(FIELD_POINTS[e].x,FIELD_POINTS[e].y,FIELD_POINTS[e+1].x,FIELD_POINTS[e+1].y,e);h.push(t)}var t=new CEdge(FIELD_POINTS[FIELD_POINTS.length-1].x,FIELD_POINTS[FIELD_POINTS.length-1].y,FIELD_POINTS[0].x,FIELD_POINTS[0].y,FIELD_POINTS.length-1);h.push(t),n.push(h[21]),n.push(h[22]),n.push(h[23]),n.push(h[0]),n.push(h[1]),n.push(h[2]),n.push(h[3]),n.push(h[4]),(_=new Array).push(h[0]),_.push(h[2]),_.push(h[3]),_.push(h[4]),i.push(h[3]),i.push(h[4]),i.push(h[5]),i.push(h[6]),i.push(h[7]),i.push(h[8]),i.push(h[9]),_.push(h[8]),_.push(h[7]),_.push(h[6]),c.push(h[9]),c.push(h[10]),c.push(h[11]),c.push(h[12]),c.push(h[13]),c.push(h[14]),c.push(h[15]),c.push(h[16]),_.push(h[10]),_.push(h[11]),_.push(h[12]),_.push(h[14]),_.push(h[15]),_.push(h[16]),u.push(h[15]),u.push(h[16]),u.push(h[17]),u.push(h[18]),u.push(h[19]),u.push(h[20]),u.push(h[21]),_.push(h[18]),_.push(h[19]),_.push(h[20]),_.push(h[22]),_.push(h[23]),g=new Array;for(l=0;l<FIELD_POINTS.length;l++){var r=new CVector2(FIELD_POINTS[l].x,FIELD_POINTS[l].y);g.push(r)}N=new Array,A=new Array,p=new Array,E=new Array,B=new Array;var o=new CVector2;o.set((h[0].getNormal().getX()+h[23].getNormal().getX())/2,(h[0].getNormal().getY()+h[23].getNormal().getY())/2),o.normalize(),N.push(o);for(l=0;l<23;l++){var s=new CVector2((h[l].getNormal().getX()+h[l+1].getNormal().getX())/2,(h[l].getNormal().getY()+h[l+1].getNormal().getY())/2);s.normalize(),N.push(s)}A.push({oPoint:g[1],oNormal:N[1]}),A.push({oPoint:g[2],oNormal:N[2]}),A.push({oPoint:g[5],oNormal:N[5]}),A.push({oPoint:g[21],oNormal:N[21]}),p.push({oPoint:g[2],oNormal:N[2]}),p.push({oPoint:g[5],oNormal:N[5]}),p.push({oPoint:g[6],oNormal:N[6]}),p.push({oPoint:g[9],oNormal:N[9]}),B.push({oPoint:g[10],oNormal:N[10]}),B.push({oPoint:g[13],oNormal:N[13]}),B.push({oPoint:g[14],oNormal:N[14]}),B.push({oPoint:g[17],oNormal:N[17]}),E.push({oPoint:g[14],oNormal:N[14]}),E.push({oPoint:g[17],oNormal:N[17]}),E.push({oPoint:g[18],oNormal:N[18]}),E.push({oPoint:g[21],oNormal:N[21]}),P=new Array,I=new Array,O=new Array,d=new Array,C=new Array;for(var l=0;l<HOLE_CENTER_POS.length;l++){var f=new CVector2;f.set(HOLE_CENTER_POS[l].x,HOLE_CENTER_POS[l].y),P.push(f)}I.push(P[0]),I.push(P[1]),O.push(P[1]),O.push(P[2]),C.push(P[3]),C.push(P[4]),d.push(P[4]),d.push(P[5])},this.addEventListener=function(e,t,s){r[e]=t,o[e]=s},this.verifyCollisionBallWithRectArea=function(e){return T.x=e.getX()-BALL_RADIUS,T.y=e.getY()-BALL_RADIUS,RECT_COLLISION.contains(e.getX(),e.getY())},this._chooseQuadrant=function(e){return e.getX()<TABLE_CENTER.x?e.getY()<TABLE_CENTER.y?0:3:e.getY()<TABLE_CENTER.y?1:2},this.addBallToStack=function(e,t){if(s_iGameMode!==GAME_MODE_TIME)if(0===e.getNumber())e.setPos(CANVAS_WIDTH+BALL_DIAMETER,CUE_BALL_POS.y),e.setTmpForce(0,0),e.setCurForce(0,0);else switch(s_iGameMode){case GAME_MODE_NINE:9===e.getNumber()?(e.setPos(0,0),e.setFlagOnTable(!1),e.setTmpForce(0,0),e.setCurForce(0,0),e.setVisible(!1)):(e.inHole(t),e.setScale(.9),e.scalarProductTmpForce(.9),e.setMask(t.getX(),t.getY()));break;case GAME_MODE_EIGHT:e.inHole(t),e.setScale(.9),e.scalarProductTmpForce(.9),e.setMask(t.getX(),t.getY())}else 0===e.getNumber()?(e.setTmpForce(0,0),e.setCurForce(0,0),e.setFlagOnTable(!1),e.setVisible(!1)):(e.inHole(t),e.setScale(.9),e.scalarProductTmpForce(.9),e.setMask(t.getX(),t.getY()))},this.collideBallWithHoles=function(e,t){return distance(e.getPos(),t[0])<BALL_RADIUS?(r[ON_BALL_INTO_HOLE]&&r[ON_BALL_INTO_HOLE].call(o[ON_BALL_INTO_HOLE],e),t[0]):distance(e.getPos(),t[1])<BALL_RADIUS?(r[ON_BALL_INTO_HOLE]&&r[ON_BALL_INTO_HOLE].call(o[ON_BALL_INTO_HOLE],e),t[1]):null},this.collideBallWithPointsNormals=function(e,t,s){for(var a=0;a<s.length;a++)if(distance2(s[a].oPoint,t)<=BALL_RADIUS_QUADRO){reflectVectorV2(e.getCurForce(),s[a].oNormal);var l=e.getCurForceLen();return e.setCurForceV(s[a].oNormal),e.scalarProductCurForce(l),null,null!==e.getHole()&&r[ON_BALL_WITH_BANK]&&r[ON_BALL_WITH_BANK].call(o[ON_BALL_WITH_BANK],e),!0}return!1},this.collideBallWithBalls=function(e){if(null!==e.getHole())return!1;for(var t,a,l=new Array,n=1e4,i=0;i<s.length;i++)s[i].getNumber()!==e.getNumber()&&s[i].isBallOnTable()&&null===s[i].getHole()&&(t=distance2(e.getPos(),s[i].getPos()))<=BALL_DIAMETER_QUADRO&&(l.push({oBall:s[i],iDist:t,index_ball:i}),n>t&&(n=t,a=l.length-1));if(0===l.length)return!1;var u=new CVector2,c=new CVector2,h=new CVector2;h.setV(e.getCurForce()),h.invert(),h.normalize(),c.setV(e.getPos()),c.subtract(l[a].oBall.getPos()),c.normalize(),u.setV(c),u.scalarProduct(1.05*BALL_DIAMETER),u.add(l[a].oBall.getPos()),e.setPosV(u);var _,L=angleBetweenVectors(h,c)/HALF_PI;if(0===e.getNumber()&&L<.3){var g=s_oInterface.getBackSpin(),N=new CVector2;c.getNormalize(N),this._addSideSpinEffect(h,-1,h,e),_=this._addBackSpinEffect(e,g,c,h)}else{var A=new CVector2;A.setV(e.getCurForce()),A.normalize(),_=e.getCurForceLen(),e.setCurForceV(reflectVectorV2(c,A))}var p=_*K_IMPACT_BALL;return e.normalizeCurForce(),e.scalarProductCurForce(.8*p*L+.15*p),c.invert(),c.normalize(),c.scalarProduct(p*(1-L)+.2*p),l[a].oBall.addForce(c),r[ON_BALL_WITH_BALL]&&r[ON_BALL_WITH_BALL].call(o[ON_BALL_WITH_BALL],e,l[a].oBall,p),0===e.getNumber()&&s_oTable.setFirstBallCollision(l[0].oBall),!0},this._addBackSpinEffect=function(e,t,r,o){var s=e.getCurForceLen(),a=new CVector2;if(a.setV(e.getCurForce()),0===t)a.normalize(),s=e.getCurForceLen(),e.setCurForceV(reflectVectorV2(r,a));else{var l=linearFunction(t,0,MAX_SPIN_VALUE,0,MAX_BACK_SPIN_CUE_FORCE),n=e.getCurForceLen()/MAX_POWER_FORCE_BALL;s=e.getCurForceLen()+l*n,t<0&&e.setCurForceV(o)}return s},this.collideBallWithEdges=function(e,t,s){var a=new CVector2;a.setV(e.getCurForce()),a.normalize();var l=e.getCurForceLen();if(0===l)return!1;var n=Math.floor(l/.2),i=!1,u=new CVector2;u.setV(e.getPrevPos()),a.normalize(),a.scalarProduct(.2);for(var c=0;c<n+1;c++){if(c===n&&(a.normalize(),a.scalarProduct(l-.2*n)),u.add(a),!this.verifyCollisionBallWithRectArea(u)){if(this.collideBallWithPointsNormals(e,u,s))return u.subtract(a),e.setPosV(u),!0;for(var h=0;h<t.length;h++)if(i=collideEdgeWithCircle(t[h],u,BALL_RADIUS,null)){u.subtract(a);break}if(i){r[ON_BALL_WITH_BANK]&&r[ON_BALL_WITH_BANK].call(o[ON_BALL_WITH_BANK],e,t[h]);break}}if(e.setPosV(u),this.collideBallWithBalls(e))return!1}if(i){var _=reflectVectorV2(e.getCurForce(),t[h].getNormal());e.setPosV(u),0===e.getNumber()&&this._addSideSpinEffect(_,1,t[h].calculateEdgeVector(),e),e.setCurForceV(_),_=null}else e.addPos(e.getCurForce());return e.setPosV(u),!this.collideBallWithBalls(e)&&(u=null,a=null,i)},this._addSideSpinEffect=function(e,t,r,o){var s=o.getCurForce().length(),a=o.getSideEffect();if(0!==a){o.setSideEffect(.25*a);var l=a/MAX_SPIN_VALUE;l*=MAX_SPIN_VALUE;var n=radiantsToDegrees(angleBetweenVectors(e,r)),i=new CVector2(e.getX(),e.getY()),u=radiantsToDegrees(angleBetweenVectors(i,r)),c=n<u,h=a>0;i.set(e.getX(),e.getY());var _=_=linearFunction(s,MAX_POWER_FORCE_BALL,0,.4,.7);h||c?c&&h&&u<90&&(l*=-1):u<90&&(l*=-1);var L=t-_;rotateVector2D(toRadian(l*L),i),e.set(i.getX(),i.getY())}},this.checkBallPosInHole=function(e,t){if(null!==t&&0!==e.getNumber()&&e.isBallOnTable()){var r=new CVector2;r.setV(t),(e.getCurForceLenght2()<K_MIN_FORCE||distance(e.getPos(),r)>DIST_BALL_HOLE)&&(e.setFlagOnTable(!1),setTimeout(function(){F.respawnBallInRails(e)},2e3))}},this.respawnBallInRails=function(e){e.reset3DObjectTransformation(),e.setScale(1),e.setPos(POS_RAIL_EXIT.x,POS_RAIL_EXIT.y),e.setTmpForce(0,0),s_iGameMode===GAME_MODE_NINE?e.setCurForce(3*(BALL_NUMBER-l)/BALL_NUMBER,0):e.setCurForce(8.98*(BALL_NUMBER-l)/BALL_NUMBER,0),l+=.76,e.removeMask()},this.areBallsStopped=function(){return t},this.getEdgesByHoleID=function(e){var t=null;switch(e){case 0:t=n;break;case 1:t=[h[1],h[5]];break;case 2:t=i;break;case 3:t=c;break;case 4:t=[h[13],h[17]];break;case 5:t=u}return t},this.getEdges=function(){return[n[0],i[0],i[1],c[1],u[0],u[1]]},this.update=function(e){var r;s=e,t=!0;for(var o=0;o<e.length;o++){if((r=e[o]).addCurForce(r.getTmpForce()),r.setTmpForce(0,0),r.setPrevPos(r.getPos()),r.isBallOnTable()){var a,l,h;switch(this._chooseQuadrant(r)){case 0:a=I,l=n,h=A;break;case 1:a=O,l=i,h=p;break;case 2:a=C,l=c,h=B;break;case 3:a=d,l=u,h=E}if(null===r.getHole()){var L=this.collideBallWithHoles(r,a);if(null!==L){this.addBallToStack(r,L);var g=new CVector2;g.set(L.getX()-r.getX(),L.getY()-r.getY()),g.normalize();for(var N=0;N<5;N++)r.addPos(g)}else this.collideBallWithEdges(r,l,h)}else this.collideBallWithEdges(r,_,h),this.checkBallPosInHole(r,r.getHole())}else r.addPos(r.getCurForce());r.scalarProductCurForce(K_FRICTION),r.getCurForceLenght2()<K_MIN_FORCE?r.setCurForce(0,0):r.isBallOnTable()&&(t=!1)}},this._init(e)}